{"version":3,"sources":["index.ts"],"names":[],"mappings":";AAAA,aAAA,IAAA,EAAA,MAAA,KAAA,UAAA,WAAA,OAAA,EAAA,OAAA,QAAA,SAAA,GAAA,IAAA,IAAA,EAAA,EAAA,EAAA,EAAA,UAAA,OAAA,EAAA,EAAA,IAAA,IAAA,IAAA,KAAA,EAAA,UAAA,GAAA,OAAA,UAAA,eAAA,KAAA,EAAA,KAAA,EAAA,GAAA,EAAA,IAAA,OAAA,IAAA,MAAA,KAAA,YAAA,OAAA,eAAA,QAAA,aAAA,CAAA,OAAA,IAAA,IAAA,EAAA,WAKE,SAAA,EAAY,GAJJ,KAAA,QAAU,IAAI,IACd,KAAA,WAAa,EAId,KAAA,YAAc,GAAgB,OAAO,MAyD9C,OAtDU,EAAA,UAAA,SAAR,SAAiB,GACR,OAAA,MAAM,KAAK,GACf,OAAO,SAAC,EAAG,GAAO,OAAA,KAAK,KAAK,GAAI,GAAK,EAAE,WAAW,GAAM,GAAG,GAC3D,YAGG,EAAA,UAAA,UAAR,SAAkB,EAAa,EAAsB,GAC5C,OAAA,KAAK,SACV,GACG,EAAQ,QAAU,OACnB,KAAK,UAAU,IACd,EAAS,KAAK,SAAW,MAIxB,EAAA,UAAA,UAAR,SAAkB,EAAa,EAAK,EAAS,EAAS,GAAtD,IAAA,EAAA,KACO,KAAA,QAAQ,IAAI,EAAK,CACpB,QAAS,KAAK,YAAY,EAAG,EAAA,GAAO,IACjC,KAAK,SAAA,GAAQ,OAAA,EAAK,QAAQ,EAAK,UAAW,KAC1C,MAAM,SAAA,GAAO,OAAA,EAAK,QAAQ,EAAK,SAAU,KACzC,KAAK,SAAA,GAAK,OAAA,EAAK,QAAQ,KAC1B,UAAW,CAAC,CAAE,QAAO,EAAE,OAAM,IAC7B,MAAO,QAIH,EAAA,UAAA,SAAR,SAAiB,EAAK,EAAU,GACE,OAA3B,KAAA,QAAQ,IAAI,GAAK,MAClB,EAAS,KAAK,QAAQ,IAAI,GAAK,MAAM,SACrC,KAAK,QAAQ,IAAI,GAAK,UAAU,KAAK,CAAE,SAAQ,EAAE,SAAQ,KAGvD,EAAA,UAAA,QAAR,SAAgB,EAAK,EAAM,GACpB,KAAA,QACF,IAAI,GACJ,UAAU,QAAQ,SAAA,GAAY,OAAA,EAAS,GAAM,EAAS,WAC5C,YAAT,IAAoB,KAAK,QAAQ,IAAI,GAAK,MAAQ,IAGhD,EAAA,UAAA,QAAR,SAAgB,GAAhB,IAAA,EAAA,KACE,WACE,WAAM,OAAA,EAAK,QAAQ,OAAO,IACM,OAAhC,KAAK,QAAQ,IAAI,GAAK,MAAiB,KAAK,WAAa,IAItD,EAAA,UAAA,MAAP,SAAa,EAAa,EAA2B,GAArD,IAAA,EAAA,UAA0B,IAAA,IAAA,EAAA,SAA2B,IAAA,IAAA,GAAA,GAC7C,IAAA,EAAM,KAAK,UAAU,EAAK,EAAS,GAClC,OAAA,IAAI,QAAQ,SAAC,EAAS,GAC3B,EAAK,QAAQ,IAAI,GACb,EAAK,SAAS,EAAK,EAAS,GAC5B,EAAK,UAAU,EAAK,EAAK,EAAS,EAAS,MAGrD,EA/DA,GAAA,QAAA,QAAA","file":"fetch-in-flight.min.js","sourceRoot":"../src","sourcesContent":["export default class FIF {\n  private flights = new Map();\n  private CACHE_TIME = 0;\n  private CACHE_FETCH;\n\n  constructor(fetch) {\n    this.CACHE_FETCH = fetch ? fetch : window.fetch;\n  }\n\n  private hashCode(code: string): string {\n    return Array.from(code)\n      .reduce((s, c) => (Math.imul(31, s) + c.charCodeAt(0)) | 0, 0)\n      .toString();\n  }\n\n  private uniqueKey(url: string, options: RequestInit, unique: boolean) {\n    return this.hashCode(\n      url +\n        (options.method || \"GET\") +\n        JSON.stringify(options) +\n        (unique ? Math.random() : \"\")\n    );\n  }\n\n  private newFlight(key: string, url, options, resolve, reject) {\n    this.flights.set(key, {\n      promise: this.CACHE_FETCH(url, { ...options })\n        .then(data => this.landing(key, \"resolve\", data))\n        .catch(err => this.landing(key, \"reject\", err))\n        .then(_ => this.cleanUp(key)),\n      listeners: [{ resolve, reject }],\n      cache: null\n    });\n  }\n\n  private inFlight(key, resolver, rejecter) {\n    this.flights.get(key).cache !== null\n      ? resolver(this.flights.get(key).cache.clone())\n      : this.flights.get(key).listeners.push({ resolver, rejecter });\n  }\n\n  private landing(key, type, response: Response) {\n    this.flights\n      .get(key)\n      .listeners.forEach(listener => listener[type](response.clone()));\n    if (type === \"resolve\") this.flights.get(key).cache = response;\n  }\n\n  private cleanUp(key) {\n    setTimeout(\n      () => this.flights.delete(key),\n      this.flights.get(key).cache !== null ? this.CACHE_TIME : 0\n    );\n  }\n\n  public fetch(url: string, options: RequestInit = {}, unique = false) {\n    const key = this.uniqueKey(url, options, unique);\n    return new Promise((resolve, reject) => {\n      this.flights.get(key)\n        ? this.inFlight(key, resolve, reject)\n        : this.newFlight(key, url, options, resolve, reject);\n    });\n  }\n}\n"]}